# 読書記録アプリ｜仕様まとめ（実装版）

> 方針：**シンプル／安全第一／デモ用途**。機能の盛り込み・付加価値は行わず、最小限の CRUD と明確な責務分離に集中する。  
> 本ドキュメントは、**実装完了時点の挙動**に合わせて更新した仕様の要約。

---

## アプリ概要

- シンプルな「個人向け読書記録アプリ（デモ用）」。
- **複数のデモユーザーでログインし、書籍・読書ログ・メモ・月次統計などの機能を試せる構成**。
- 認証はあくまで **デモ用の疑似認証**。本格的なサインアップ／パスワード管理は行わない。
- **閲覧専用ユーザーを含めた安全なデモ運用**と、**URL 等の入力ガード**を重視。

---

## デモ認証

- **デモユーザー4名**：
  - 通常ユーザー **3名**：`demo-1`, `demo-2`, `demo-3`
  - **読み取り専用ユーザー 1名**：`demo-readonly`
- **初期状態**：`demo-1` でログイン済みの状態からスタート。
- **ログイン画面**：
  - プルダウンでユーザーを選択し、「ログイン」ボタンで即切り替え。
  - **パスワード入力は無し**（デモ用である旨を明示）。
  - ログアウト機能は無し（常にいずれかのデモユーザーとして操作）。
- **読み取り専用ユーザー**：
  - UI 上で、**書き込み系フォームやボタンは非活性／非表示**。
  - サーバー側でも、書き込み系 API（POST/PATCH/DELETE）は **403 Forbidden** でブロック。
- **ユーザー登録画面**：
  - 画面自体は `/register` として存在するが、**新規登録フォームは提供しない**。
  - 「学習用デモのため、新規登録は行えない」旨の説明のみ表示。

---

## 書籍（Books）

- **必須項目**：
  - 書籍名（タイトル）
  - 総ページ数（正の整数）
- **任意項目**：
  - 著者
  - 出版社
  - ISBN（**10桁 or 13桁の数字のみ、保存・表示ともハイフン無し**）
- **書籍メモ**：
  - 書籍そのものに対するメモは **Books テーブルには持たせず**、
  - **別テーブルのメモ（Notes）として書籍に紐付く形**で管理（後述）。
- **状態（state）**：
  - `reading`（読書中） / `done`（読書済）の 2値。
  - `pages_read >= total_pages` になったタイミングで `done` へ自動遷移。
  - ユーザーが手動で状態を切り替える機能は **提供しない**。
- **進捗・カウンタ**：
  - `pages_read`：現在までの累計読了ページ数。
  - `minutes_total`：現在までの累計読書時間（分）。
  - これらは **読書ログ登録時に自動更新**される（直接編集は不可）。
- **削除**：
  - 書籍削除は **ソフトデリート**。
  - 一覧・詳細の通常操作では「削除済み書籍」は表示されない（ゴミ箱ビュー等は無し）。
- **重複登録**：
  - 同一ユーザー内で、**同名・同著者の書籍を登録可能**（版／翻訳違いなど）。
  - 既存データと一致する場合は、登録画面で **警告のみ表示**し、登録自体は許可。

---

## 読書ログ（Reading Logs）

- **入力方式**：
  - ユーザーは **「その時点での累計読了ページ数（pages_now）」** を入力する。
  - 保存時に、前回の `pages_read` との差分を自動計算し、UI では **「＋Nページ」** として表示。
- **入力項目**：
  - 累計読了ページ数（必須）
  - 読書時間（分・任意）
  - 短いメモ（任意、※リンク禁止／文字数上限あり）
  - 日付（ログの日付。既定は本日。過去日は可／未来日は不可）
- **保存時の処理**：
  - 新しい `pages_now` が **前回の `pages_read` 未満ならエラー**。
  - `pages_now` が総ページ数を超える場合は、**総ページ数に丸めて保存**。
  - `pages_read` と `minutes_total` を **トランザクション内で一貫して更新**。
  - `pages_read >= total_pages` になった場合、自動的に状態 `done` へ遷移。
- **ログ履歴**：
  - 書籍詳細画面にて、**最新順（新しいものが上）で一覧表示**。
  - 各ログは「日付・＋Nページ・累計ページ・読書時間・メモ」のような要約で表示。
- **Undo（直前ログの取り消し）**：
  - 各書籍について、**最新の 1件だけ** Undo 対象。
  - Undo 実行時：
    - 最新ログレコードを削除。
    - `pages_read` / `minutes_total` を **直前の状態に巻き戻す**。
  - 過去ログの任意修正・任意削除機能は **提供しない**。

---

## メモ（Notes）

- **目的**：
  - 読書ログとは独立した、**自由記述のメモ**を残せるようにするための機能。
  - 書籍に紐付いて保存される。
- **操作**：
  - 書籍詳細画面にて、メモの **追加／編集／削除／一覧確認** が可能。
- **入力制約**：
  - 本文：最大 **500文字** 程度。
  - 改行は許可。
  - URL・リンクは後述の **入力ガードにより禁止**。
- **表示**：
  - ログとは別のセクションで、**最新順** に一覧表示。
  - 「作成日時（または更新日時）＋本文」でシンプルに表示。

---

## 一覧画面（Books List）

- **パス**：`/books`
- **並び順**：
  - デフォルトは状態順 + 最終更新時刻順。
    1. `reading`（読書中）を上に表示。
    2. 各状態内では、**最終更新日時（最新ログ日時など）降順**。
- **検索**：
  - 書籍名と著者名の **部分一致** 検索。
- **フィルタ**：
  - 状態によるフィルタ：`すべて / 読書中 / 読書済`。
- **カード表示（Book Card）**：
  - 書籍名、著者
  - 進捗バー（％・ページ表示）
  - 総読書時間（累積分）
  - 最終更新日時
- **クイック更新**：
  - 各カード上で、**累計読了ページ数** と **読書時間（分）**・**短いメモ**を入力し、そのまま読書ログとして登録できる。
  - 成功時はカードを再描画し、「＋Nページ」などの成功メッセージを表示。
- **読み取り専用ユーザーの場合**：
  - クイック更新フォームは非活性、もしくは表示自体を抑制し、閲覧のみに制限。

---

## 詳細画面（Book Detail）

- **パス**：`/books/:id`
- **主な表示内容**：
  - 書籍の基本情報（タイトル・著者・出版社・ISBN）
  - 進捗情報（％・累計ページ数・累計読書時間）
- **編集**：
  - 書籍情報（著者・出版社・ISBN など）の編集が可能。
  - タイトル／総ページ数も、バリデーションを満たす範囲で更新可能。
- **進捗更新フォーム**：
  - 「現時点の累計読了ページ数」と任意の読書時間を入力し、読書ログとして登録。
  - 入力時に「＋Nページ」を即時計算して表示。
- **ログ履歴**：
  - 書籍に紐付くログを最新順で一覧表示。
  - Undo ボタンによって「最新のログ」のみ削除可能。
- **メモセクション**：
  - Notes 機能によるメモ追加フォーム（textarea ≤ 500）。
  - メモ一覧（最新順）と、必要に応じた編集／削除操作。

---

## 新規書籍登録

- **パス**：`/books/new`
- **目的**：
  - 書籍の新規登録に必要な入力・バリデーションを 1 画面で完結させる。
- **入力項目**：
  - 必須：書籍名、総ページ数
  - 任意：著者、出版社、ISBN
- **仕様**：
  - モーダルを用いた「クイック追加」は **採用せず**、専用画面のみ。
  - バリデーションエラーはフィールド下に表示。
  - 同名・同著者が存在する場合は警告表示しつつ、登録は許可。

---

## 軽量統計

- **表示場所**：
  - 書籍一覧画面の上部に「今月の読書統計バー（Stats Bar）」を表示。
- **内容**：
  - 指定された年月（初期値は当月）の
    - **合計読了ページ数**
    - **1日あたり平均ページ数**（「平均（日）」）
  - ざっくりとした傾向を把握するための軽量な統計に留める（グラフ等は無し）。
- **月切り替え**：
  - プルダウン等で **過去月を選択可能**。
  - 選択された年月に応じて統計値を再取得・再表示。

---

## ローディング／エラー表示・文言の統一

- **メッセージ定義**：
  - フロントエンドでは `MSG` オブジェクトに、画面で使用するメッセージ ID と文言を一元管理する。
    - バリデーションメッセージ
    - 一覧のエンプティ状態
    - 確認ダイアログ文言
    - ローディング／エラー系の UI コピー  
    などをここに集約し、コンポーネント内に日本語文言をベタ書きしない方針とする。
  - バックエンドでも、メッセージ定義モジュールにAPI 応答で返すメッセージ ID／日本語文言を集約する。
    - バリデーションエラー
    - ビジネスルール違反
    - 読み取り専用ユーザーによる書き込み試行  
    などのエラー時には、この定義からメッセージを取得して `message` フィールドとして返す。
  - フロントエンドは、**「フロント専用の UI 文言」** と **「サーバーから返ってくるメッセージ」** を使い分ける。
    - サーバー由来のメッセージは極力そのまま表示し、重複定義は避ける（同じ意味のメッセージを FE 側に再定義しない）。
- **ローディング状態**：
  - 一覧・詳細画面の初回読み込み時は、カードの **Skeleton UI** と「読み込み中」文言を表示。
  - 時間がかかる場合（例：Render 上のバックエンドがコールドスタート中）には、
    - **「初回アクセス時はサーバー起動のため数十秒かかる場合がある」**
    - **「画面を閉じずにそのままお待ちください」**
    といった注意文 + スピナーを追加表示し、ユーザーに状況を明示。
- **エラー表示**：
  - API エラー時は、カード一覧の代わりに「取得に失敗しました」等の明示的なエラー枠を表示。
  - 読み取り専用ユーザーで書き込み操作を試みた場合などは、**専用のエラーメッセージ**を返す。

---

## 日付／時刻の扱い

- **基準タイムゾーン**：日本時間（Asia/Tokyo）。
- **ログの日付**：
  - UI 上で選択した日付を JST として解釈。
  - 「今日」の既定値も JST ベースで算出。
- **集計**：
  - 月次統計は JST ベースで「年月」を決定し、その範囲のログを集計する。

---

## 入力ガード（リンク／安全面）

- **対象**：
  - 書籍タイトル・著者・出版社
  - ログメモ
  - Notes（メモ）本文
  - その他テキスト入力欄
- **方針**：
  - すべての入力に対し、**URL やリンクらしき文字列を禁止**。
- **判定例**：
  - `://` を含む文字列（`http://`, `https://`, `ftp://` 等）
  - `www.` や、ごく一般的な短縮 URL ドメインを含む文字列
- **その他の安全策**：
  - Unicode 正規化・ゼロ幅文字の除去を行った上でリンク判定を行う。
  - 画面表示時は常にテキストとしてエスケープし、HTML としては解釈しない。
- **UI での明示**：
  - 「学習用デモのため、セキュリティ上の理由から外部リンク登録はできません。」などの注意書きを画面上に表示。

---

## デモ運用（初期化／シード）

- アプリ内に **初期化 UI は設けない**。
- デモデータはサーバー側のスクリプト／SQL で管理：
  - 例：`backend/seed.js` と `sql/0001_demo_users.sql` 〜 `0004_demo_notes.sql` など。
  - 開発者がコマンドラインから実行して、DB を初期化／再シードする運用を想定。
- 本番デモ環境でも、必要に応じて **運用者が手動でリセット**する前提（ユーザー側からは操作不可）。

---

## 画面と動線

- **ヘッダー**：
  - ログイン／書籍一覧／新規書籍登録／（ユーザー登録画面）。
- **ログイン画面**：
  - デモユーザーのプルダウン + ログインボタン。
  - 新規登録は不可である旨のテキストのみ表示。
- **書籍一覧**：
  - 検索フォーム（キーワード・状態フィルタ）。
  - 軽量統計バー。
  - 書籍カードのグリッド表示。
  - クイック更新（読み取り専用ユーザーでは無効）。
- **新規書籍**：
  - 必須2項目 + 任意項目を入力し、新規登録。
- **書籍詳細**：
  - 基本情報表示・編集。
  - 進捗情報（％・累計ページ・累計時間）。
  - 読書ログ履歴 + Undo。
  - メモ（Notes）の追加／編集／削除・履歴一覧。
- **その他**：
  - 存在しないパスは Not Found 画面に遷移。

---

## バリデーション（要点の整理）

- **タイトル**：
  - 必須。空文字・空白のみはエラー。
  - リンク禁止。
- **総ページ数**：
  - 1以上の整数。上限は実用的な範囲（例：100,000）。
- **累計読了ページ数（ログ入力）**：
  - 0〜総ページ数。
  - **前回値未満はエラー**。
  - 入力値 > 総ページ数の場合は総ページ数に丸めて保存。
- **読書時間**：
  - 0以上の整数（分）。任意項目。
- **ISBN**：
  - 空欄可。
  - 入力がある場合は **10桁 or 13桁の数字のみ（ハイフン無し）**。
- **メモ（ログメモ／Notes）**：
  - 最大 **500文字**。
  - リンク禁止。
- **日付**：
  - 本日以前のみ（JST）。未来日はエラー。
- **読み取り専用ユーザー**：
  - 書き込みAPIは常に 403 Forbidden を返却。

---

## 採用技術

- **フロントエンド**：
  - JavaScript + React
  - Vite（ビルド／開発サーバ）
  - Tailwind CSS（デザイントークン + カスタムユーティリティ）
- **バックエンド**：
  - Node.js + Express
  - ルーティング層／コントローラ層／サービス層／リポジトリ層／SQL（.sql ファイル）による責務分離。
  - PostgreSQL 用クライアント `pg` による接続（コネクションプール）。
- **データベース**：
  - PostgreSQL（Vercel Postgres を想定）。
  - Books / Logs / Notes / Users などのテーブル構成。
- **デプロイ**：
  - フロントエンド：Vercel
  - バックエンド：Render
  - DB：Vercel Postgres

---

## 備考

- 本ドキュメントは **MVP 完了時点の仕様** をまとめたもの。
- 詳細な API 仕様・DB スキーマ・ディレクトリ構成は、別途の **要件定義／基本設計／詳細設計** ドキュメントに記載する。
