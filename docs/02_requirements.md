# 読書記録アプリ｜企画・要件定義（実装版）

> 方針：**シンプル／安全第一／デモ用途**。機能や付加価値をむやみに盛り込まず、最小限の CRUD と明確な責務分離に集中する。  

---

## 0. プロジェクト概要 / 方針

- **題材**  
  - シンプルな「読書記録アプリ（Reading Log App）」。
  - 読書の進捗・読書時間・メモ・軽量な統計を記録する。

- **目的**
  - フロントエンド（SPA）／バックエンド（REST API）／DB を分離した構成で実装し、
    - MVC 的な責務分離
    - REST API 設計
    - フロント側での状態管理・バリデーション・ローディング体験
    をひと通り経験・整理する。
  - **実際に触れるデモアプリ**を提供する。

- **非目的**
  - 本番サービスレベルの認証・権限・多要素認証。
  - 外部API連携（書誌情報取得など）や画像アップロード・リンクプレビュー。
  - 高度な統計機能（グラフ・ランキング・AIレコメンド等）。
  - ブラウザ外のクライアント（ネイティブアプリ等）への展開。

- **運用モード**
  - 完全に **「デモ前提」** とする。
  - ログイン／新規登録はダミー（固定のデモユーザー切り替えのみ）。
  - DB 初期化・シードはコマンドラインからのみ行い、アプリ内に初期化 UI は持たない。

- **禁止事項**
  - 全ての入力欄で **URL／リンクの混入禁止**。
    - セキュリティ・著作権・商標リスクを避けるため、`http://`, `https://`, `www.`, 短縮URLなどを検知したらエラーとする。

- **ログ／テスト方針**
  - アプリ内でのファイルログ出力は行わない（ブラウザの開発者ツール・Render ログ程度）。
  - 自動テストは用意せず、**実操作による確認のみ**を基本とする。

---

## 1. 想定ユーザー / 利用シーン

### 1.1 想定ユーザー

- 開発者本人。
- デモ環境を触ってみる第三者。

---

### 1.2 利用シーン

- デモユーザーとしてログインし、
  - 書籍を登録する。
  - 読書ログを追加し、差分で進捗が増えていく様子を確認する。
  - メモを残したり、月次統計で読書量をざっくり把握する。
- 「読み取り専用ユーザー」に切り替え、
  - 読み取り専用モードの UI／API ガードを確認する。

---

## 2. 機能要件

### 2.1 ユーザー / 認証（デモ認証）

- **デモユーザー構成**
  - デモユーザー **3名 + 読み取り専用 1名** を固定値で用意する。
    - 例：`demo-1`, `demo-2`, `demo-3`, `demo-readonly`
- **初期状態**
  - 初期アクセス時は `demo-1` としてログイン済み状態。
  - ログアウト機能は持たず、常にいずれかのデモユーザーとして動作する。
- **ログイン画面**
  - プルダウンでユーザーを選択し、「ログイン」ボタンで切り替えるだけのシンプルな画面。
  - パスワード入力は行わない（デモ用途である旨を画面上に明示）。
- **ユーザー登録画面**
  - `/register` に「新規登録はできない」旨の説明を表示する画面のみ用意。
  - 入力フォームや登録処理は提供しない。
- **読み取り専用ユーザー**
  - `demo-readonly` は **読み取り専用ユーザー** とする。
  - UI：
    - フォームや更新ボタンは非活性／非表示などで、書き込み操作をできないようにする。
  - サーバー：
    - 書き込み系 API（POST/PUT/PATCH/DELETE）はすべて **403 Forbidden** を返す。

---

### 2.2 書籍（Books）

- **提供機能**
  - 登録／一覧／詳細／更新／削除（ソフトデリート）。

- **項目**
  - 必須：
    - タイトル（書籍名）
    - 総ページ数（1以上の整数）
  - 任意：
    - 著者
    - 出版社
    - ISBN（**10桁または13桁の数字のみ**。保存・表示ともハイフン無し）

- **状態管理**
  - 状態：`reading` / `done`
  - 判定：
    - `pages_read >= total_pages` となったタイミングで自動的に `done` へ遷移。
    - 手動で `reading` ↔ `done` を切り替える UI は提供しない。

- **進捗カウンタ**
  - `pages_read`：その書籍の累計読了ページ数。
  - `minutes_total`：その書籍の累計読書時間（分）。
  - ユーザーがこれらの値を直接編集することはできず、**読書ログの登録／Undo によってのみ更新**される。

- **削除**
  - 書籍の削除は **ソフトデリート** とし、通常の一覧・詳細には表示しない。
  - ゴミ箱ビューや完全削除は今回の MVP では扱わない。

- **重複登録**
  - 同一ユーザー内で同名・同著者の書籍を複数登録できる。
  - 登録時に重複が疑われる場合は警告メッセージを表示するが、登録自体は許可する。

---

### 2.3 読書ログ（Reading Logs）

- **目的**
  - 読書の進捗を、「その時点での累計ページ数」を元に記録する。
  - 差分ページ数を自動計算し、UI 上では「＋Nページ」として分かりやすく表示する。

- **入力方式**
  - ユーザーは **「現時点での累計読了ページ数」** を入力する。
  - サーバー側で直前の `pages_read` との差分を計算し、ログには
    - 日付
    - 累計ページ数
    - 差分ページ数
    - 読書時間（分）
    - メモ
    などを保存する。

- **入力項目**
  - 日付：
    - 既定値は「今日」（JST）。
    - 過去日は選択可／未来日はエラー。
  - 累計読了ページ数：
    - 0〜総ページ数の範囲。
    - 前回の `pages_read` 未満の値はエラー。
    - 総ページ数より大きい値が入力された場合は、総ページ数に丸めて保存する。
  - 読書時間（分）：
    - 任意。0 以上の整数。
  - 短いメモ：
    - 任意。最大 500文字程度。
    - リンク禁止（後述の入力ガードを適用）。

- **保存時の仕様**
  - ログ登録時に、対象書籍の
    - `pages_read`
    - `minutes_total`
    をトランザクション内で更新する。
  - `pages_read >= total_pages` となった場合、自動的に書籍の状態を `done` に更新する。

- **履歴表示**
  - 書籍詳細画面で、最新ログが上に来るような形で一覧表示。
  - 1件ごとに「日付・＋Nページ・累計ページ・読書時間・メモ」を要約表示する。

- **Undo（直前ログの取り消し）**
  - 書籍ごとに **最新の 1件のみ** Undo 対象とする。
  - Undo 実行時：
    - 最新ログレコードを削除。
    - 対象書籍の `pages_read`／`minutes_total` を直前の値に戻す。

---

### 2.4 メモ（Notes）

- **目的**
  - 読書ログとは別に、**書籍に紐づく自由記述メモ**を残せるようにする。

- **機能**
  - 書籍詳細画面で、メモの追加／編集／削除／一覧表示が可能。
  - メモは `Notes` テーブルとして Books に紐付いて管理する。

- **入力制約**
  - 本文：最大 500文字程度。
  - 改行は許可。
  - URL・リンクは入力禁止。

- **表示**
  - 書籍詳細画面の専用セクションで、最新のメモが上に来る一覧を表示。
  - 作成日時を表示する。

---

### 2.5 統計（軽量統計）

- **目的**
  - 「今月どのくらい読んだか？」をざっくり把握できるレベルの軽量な統計を提供する。

- **内容**
  - 指定した年月（初期値：当月）の
    - 合計読了ページ数
    - 1日あたり平均ページ数
  を表示する。

- **UI**
  - 書籍一覧画面の上部に「統計バー（Stats Bar）」として表示。
  - 月選択 UI により、過去月も切り替え可能。

---

### 2.6 画面とナビゲーション

- **ヘッダー**
  - ログイン画面へのリンク。
  - 書籍一覧 `/books` へのリンク。
  - 新規書籍登録 `/books/new` へのリンク。
  - ユーザー登録画面 `/register`（説明のみ）。

- **主な画面**
  - ログイン画面：
    - デモユーザー選択 → ログイン／切替。
    - 新規登録ができない旨の説明。
  - 書籍一覧：
    - 検索（キーワード：タイトル・著者）。
    - 状態フィルタ（すべて／読書中／読書済）。
    - 軽量統計バー。
    - 書籍カード（進捗＋総読書時間＋最終更新）。
    - クイック更新フォーム（読み取り専用ユーザーでは無効／非表示）。
  - 新規書籍登録：
    - 1画面で入力からバリデーション・登録まで完結。
  - 書籍詳細：
    - 基本情報表示／編集。
    - 進捗情報（％／累計ページ／累計時間）。
    - 読書ログの履歴＋Undo。
    - メモ（Notes）の一覧／追加／編集／削除。
  - Not Found 画面：
    - 存在しないパスにアクセスした場合に表示。

---

### 2.7 ローディング／エラー表示・メッセージ

- **メッセージ定義**
  - フロントエンド：
    - `messages.js` の `MSG` オブジェクトに UI 文言を集約する。
    - バリデーションエラー・読み込み中メッセージ・エンプティ状態・確認ダイアログなどをここで管理する。
  - バックエンド：
    - メッセージ定義モジュール（`messages.js` ）を用意し、  
      バリデーションエラーやビジネスルールエラー時に `message` として返す文言を一元管理する。
  - フロントは「フロント専用の UI 文言」と「サーバー由来のメッセージ」を使い分ける。

- **ローディング**
  - 初回読み込み時には Skeleton UI と基本的な「読み込み中…」文言を表示。
  - バックエンドのコールドスタート等で 5 秒以上かかる場合：
    - 「初回アクセス時はサーバー起動に数十秒かかる場合がある」
    - 「画面を閉じずにそのままお待ちください」
    といった補足メッセージと大きめのスピナーを追加表示し、ユーザーに状況を明示する。

- **エラー**
  - API エラー時は、カード一覧の代わりにエラー枠を表示し、再読み込み等のアクションを案内する。
  - 読み取り専用ユーザーで書き込みを試みた場合は、専用のメッセージを表示する。
  - 想定外エラーについては、一般的なメッセージ（例：「不明なエラーが発生しました」）にフォールバックする。

---

## 3. 非機能要件

### 3.1 アーキテクチャ / システム構成

- **分離構成**
  - フロントエンド：Vite + React（SPA）／Vercel でホスティング。
  - バックエンド：Node.js + Express（常駐）／Render にデプロイ。
  - データベース：Vercel Postgres（PostgreSQL 互換）。
  - フロントとバックエンドは **別オリジン** とし、CORS 設定で正規フロントだけを許可する。

- **SPA ルーティング**
  - Vercel 側で、`/books/*` や `/books/:id` などのパスに直接アクセスされた場合でも `index.html` を返す。
  - これにより、SPA のクライアントサイドルーティングが機能する。

#### 3.1.1 API 方針

- **ベースパス**
  - バックエンドの HTTP API は、すべて `/api/*` 配下で提供する。

- **ユーザー識別**
  - リクエストヘッダ `X-Demo-User` でデモユーザー（`demo-1` など）を識別する。
  - フロントエンドはログイン画面で選択されたユーザーに応じて、このヘッダを付与して API を呼び出す。

- **レスポンスフォーマット**

- **CORS**
  - 環境変数 `FRONTEND_ORIGIN` に設定されたオリジンのみを許可する。

#### 3.1.2 DB 方針（Vercel Postgres）

- **利用 DB**
  - Vercel Postgres を使用し、簡易用途ではなく **実 DB 上で開発／デプロイ** する。

- **環境分離**
  - 開発・本番など各環境ごとに別の接続文字列を持つ。
  - 共有の「本番デモ DB」に対して、Render 上の API サーバから接続する想定。

- **接続方式**
  - Vercel Postgres の **pooled 用接続文字列** を用い、`pg` のコネクションプールから接続する。

#### 3.1.3 生SQL・レイヤ構成

- **生SQLの扱い**
  - DB アクセスは ORM は使わず、**生の SQL を `.sql` ファイルとして管理**する。
  - 代表例：
    - `get_book.sql`
    - `list_books.sql`
    - `insert_book.sql`
    - `insert_log.sql`
    - `list_notes.sql`  
    など、1クエリ＝1ファイルを基本とする。

- **レイヤ構成**
  - バックエンドはおおまかに以下のレイヤに分割する：
    - ルート層：`/api/...` へのルーティング定義。
    - コントローラ層：HTTP リクエスト／レスポンスとの境界、入力の取り出し、サービス呼び出し。
    - サービス層：ビジネスロジック（差分計算・状態遷移・バリデーション・権限チェックなど）。
    - リポジトリ層：`.sql` ファイルの読み込み＋ `pg` を用いたクエリ実行。
    - DB 接続層：コネクションプールの生成。
  - **目的**：
    - SQL を可視化しやすくする（`.sql` ファイルを開くだけでクエリが読める）。
    - HTTP／ビジネスロジック／DB アクセスの責務を分離し、変更の影響範囲を限定する。

#### 3.1.4 デプロイ・環境変数（方針）

- **デプロイ先**
  - フロントエンド：Vercel（ビルド→静的ファイル配信＋SPA ルーティング）。
  - バックエンド：Render（Node.js 常駐プロセス）。
  - DB：Vercel Postgres。

- **環境変数（方針レベル）**
  - バックエンド側：
    - `PORT`：Render が割り当てるポート番号を利用。
    - `DATABASE_URL` / `DATABASE_URL_POOLED`：Vercel Postgres の接続文字列。
    - `FRONTEND_ORIGIN`：CORS 許可するフロント URL。
    - その他、デモユーザー関連設定等。
  - フロントエンド側：
    - `VITE_API_BASE_URL`：Render のバックエンド URL。
    - `VITE_APP_ENV` 等、必要に応じた実行環境の判別用フラグ。
  - これらのキー名・構成は **詳細設計／README の「環境変数」セクションで具体値を定義**し、要件定義では「環境変数で外だしし、`.env.example` で雛形を管理する」という方針の記載に留める。

---

### 3.2 セキュリティ / 入力ガード

- 全入力欄で **URL／リンクっぽい文字列を禁止**。
  - `://`、`www.`、代表的な短縮URLドメインなどを検知。
  - Unicode 正規化（NFKC）やゼロ幅文字除去を行った上で判定する。
- 表示時は常に HTML エスケープを行い、入力文字列が HTML として解釈されないようにする。
- 読み取り専用ユーザーへのガードを FE／BE 両方で行う。

---

### 3.3 性能・可用性

- レイテンシ：
  - 通常操作は数秒以内に応答することを想定。
  - Render のコールドスタートを想定し、**初回リクエストに時間がかかる場合でも UI 上で明示して離脱を防ぐ**。

---

### 3.4 運用・環境

- DB マイグレーション：
  - 番号付き SQL（`0001_init.sql` 等）で管理し、スクリプト（`migrate.js` 等）から適用する。
- シード：
  - `seed.js` と `0001_demo_users.sql` 〜 `0004_demo_notes.sql` 等でデモユーザー・書籍・ログ・メモを投入。
  - 開発者／運用者がコマンドラインから実行する前提で、アプリ内にはリセットUIを持たない。
- ログ：
  - Render 側のログ・ブラウザのコンソールログを手がかりにデバッグを行う。
- 環境分離：
  - 開発用の `.env`／本番の Render/Vercel の環境変数を使い分ける。
  - リポジトリには `.env.example` のみを含め、秘密情報はコミットしない。

---

## 4. 非対象（今回のMVPで扱わないもの）

- 画像アップロード、書影の取得、外部サイトへのリンクプレビュー。
- 書誌情報 API（Google Books API 等）との連携。
- タグやカテゴリによる高度な検索・フィルタ・ソート。
- 書籍・ログ・メモのエクスポート／インポート機能（CSV/JSON 等）。
- JWT や OAuth2 などの本格的な認証・権限管理。
- モバイルアプリ／ブラウザ拡張など、Web 以外のクライアント。

---

## 5. その他のドキュメントとの関係

- 本ドキュメントは「**何を実現するか／どこまでをMVPとするか**」を定義したもの。
- このあと参照すべきドキュメント：
  - **基本設計**：画面一覧・API 一覧・DB テーブル一覧など、項目レベルの構造。
  - **詳細設計**：ディレクトリ構成、レイヤ分割、SQL ファイル構成、処理フロー等。

